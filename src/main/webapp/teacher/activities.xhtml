<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <h:head>
        <title>Gamified Reflection</title>
        <h:outputStylesheet library="webjars" name="bootstrap/3.3.7-1/css/bootstrap.min-jsf.css" />
        <h:outputStylesheet library="webjars" name="font-awesome/4.7.0/css/font-awesome-jsf.css" />
        <style>
            #{categoriesController.styles}

            .selected {
                color: blue !important;
            }

            .not-selected {
                color: black !important;
            }

            .fa-calendar-o {
                height: inherit;
            }

            .ui-tabmenu .ui-tabmenu-nav {
                padding-left: .5em
            }

            .ui-tabmenuitem.ui-state-default.ui-corner-top:last-child {
                float: right !important;
                background-color: #990033 !important;
                background: none;
                color: white;
            }
            
            #newEventDlg_title {
                margin-right: 0;
                width: fit-content;
            }
            
            .ui-dialog-titlebar {
                height: auto;
            }
            
            .ui-dialog-content {
                width: 100% !important; 
                height: 85% !important;
            }
            
            .ui-dialog-footer {
                text-align: right !important;
            }
            
            #newEventDlg {
                height: 80vh !important;
                width: 60vw !important;
                overflow: visible;
            }
            
        </style>
    </h:head>
    <h:body>
        <ui:include src="header.xhtml"/>

        <div class="container-fluid">

            <p:panel class="row">
                <h2> Select a skill to manage the corresponding activities </h2>
                <br></br>
                <div class="col-md-6">
                    <h:form id="categoryForm">
                        <p:dataTable id="categoriesList"
                                     value="#{categoriesController.categories}"
                                     var="category"
                                     editable="true">

                            <p:ajax event="rowEdit" listener="#{categoriesController.onRowEditCategory}" update="@form:categoriesList" />

                            <p:column headerText="Skills">
                                <p:cellEditor>
                                    <f:facet name="output"><p:commandLink styleClass="#{categoriesController.selectedCategory eq category ? 'selected' : 'not-selected'}" onclick="document.getElementById('activitiesForm').scrollIntoView()" actionListener="#{categoriesController.setSelectedCategory(category)}" value="#{category.title}" ajax="true" process="@this" update=":activitiesForm:activities, :activitiesForm:newActivityButton, @form" /></f:facet>
                                    <f:facet name="input"><p:inputText id="titleInput" value="#{category.title}" style="width:100%"/></f:facet>
                                </p:cellEditor>
                            </p:column>
                            <p:column headerText="Edit" style="width:10%">
                                <p:rowEditor />
                            </p:column>
                            <p:column headerText="Delete" style="width:15%" class="text-center">
                                <p:commandLink value="X" style="color: red" actionListener="#{categoriesController.deleteCategory(category)}">
                                    <p:confirm header="Confirmation" message="Are you sure you want to delete '#{category.title}'? All related activities will be lost!" icon="ui-icon-alert" />
                                </p:commandLink>

                                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                                    <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                                    <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                                </p:confirmDialog>
                            </p:column>
                        </p:dataTable>
                        <p:commandButton value="Add New Skill" type="button" onclick="PF('newCategoryDialog').show();" />
                    </h:form>
                </div>

                <div class="col-md-6">
                    <h:form id="activitiesForm">
                        <p:dataTable
                            id="activities"
                            value="#{categoriesController.categoryActivities}"
                            var="activity"
                            styleClass="#{categoriesController.selectedCategory eq null ? 'empty' : ''}"
                            emptyMessage="#{categoriesController.selectedCategory eq null ? 'Please select a skill' : 'No activities added'}"
                            editable="true">

                            <p:ajax event="rowEdit" listener="#{categoriesController.onRowEditActivity}" update="@this" />

                            <p:column headerText="#{categoriesController.selectedCategory.title} Activities">
                                <p:cellEditor>
                                    <f:facet name="output"><h:outputText value="#{activity.title}" /></f:facet>
                                    <f:facet name="input"><p:inputText id="titleInput" value="#{activity.title}" style="width:100%"/></f:facet>
                                </p:cellEditor>
                            </p:column>
                            <p:column headerText="Edit" style="width: 10%">
                                <p:rowEditor />
                            </p:column>
                            <p:column headerText="Schedule" style="width: 20%;" class="text-center">
                                <p:commandButton icon="fa fa-calendar-o" oncomplete="PF('schedulerDialog').show();" actionListener="#{categoriesController.setSelectedActivity(activity)}" update=":newEventDlg" style="height: 35px"/>
                                <!--                        <p:commandLink value="#//{activity.enabled ? 'Disable' : 'Enable'}" styleClass="#//{!activity.enabled ? 'enabled' : 'disabled'}" actionListener="#//{activitiesController.toggleEnabled(activity)}" ajax="true" update=":activitiesForm"/>-->
                            </p:column>
                            <p:column headerText="Delete" style="width: 15%" class="text-center">
                                <p:commandLink value="X" style="color: red" actionListener="#{categoriesController.deleteActivity(activity)}" ajax="true" update="@form:activities">
                                    <p:confirm header="Confirmation" message="Are you sure you want to delete '#{activity.title}'? Scheduled activities will be deleted!" icon="ui-icon-alert" />
                                </p:commandLink>
                            </p:column>
                        </p:dataTable>
                        <p:commandButton id="newActivityButton" disabled="#{categoriesController.selectedCategory eq null}" value="Add New Activity" type="button" onclick="PF('newActivityDialog').show();" style="float: right"/>
                    </h:form>
                </div>
            </p:panel>
        </div>
    </h:body>

    <p:dialog widgetVar="newCategoryDialog" modal="true" dynamic="true" height="100px" showHeader="true" header="Add new skill">
        <p:panel>
            <h:form>
                <p:inputText value="#{categoriesController.newCategoryTitle}"/>
                <p:commandButton actionListener="#{categoriesController.addCategory(categoriesController.newCategoryTitle)}" value="OK" oncomplete="PF('newCategoryDialog').hide();" update="@(:categoriesList)"/>
            </h:form>
        </p:panel>
    </p:dialog>
    <p:dialog widgetVar="newActivityDialog" modal="true" dynamic="true" height="100px" showHeader="true" header="Add new activity">
        <p:panel>
            <h:form>
                <p:inputText value="#{categoriesController.newActivityTitle}"/>
                <p:commandButton actionListener="#{categoriesController.addActivity(categoriesController.newActivityTitle, categoriesController.selectedCategory)}" value="OK" oncomplete="PF('newActivityDialog').hide();}" ajax="true" update="@(:activitiesForm)" resetValues="true"/>
            </h:form>
        </p:panel>
    </p:dialog>
    <p:dialog id="newEventDlg" widgetVar="schedulerDialog" modal="true" header="Select date on which '#{categoriesController.selectedActivity.title}' will be enabled. Click on existing activity to delete." dynamic="true" position="center" closeOnEscape="true" resizable="true" closable="false">
        <h:form id="scheduleForm">
            <p:schedule  id="schedule" value="#{categoriesController.scheduleModel}" widgetVar="schedule" timeZone="GMT+2" leftHeaderTemplate="" centerHeaderTemplate="prev title next" rightHeaderTemplate="none">
                <p:ajax event="dateSelect" listener="#{categoriesController.onDateSelect}" update="@this"/>
                <p:ajax event="eventSelect" listener="#{categoriesController.onEventSelect}"  oncomplete="PF('deleteDialog').show();" update=":deleteEventDlg"/>
            </p:schedule>
        </h:form>
        <f:facet name="footer" >
            <p:commandButton value="Save and Close" oncomplete="PF('schedulerDialog').hide();"/>
        </f:facet>
    </p:dialog>
    <p:dialog id="deleteEventDlg" widgetVar="deleteDialog" modal="true" header="Delete scheduled activity?" dynamic="true">
        <h:form id="deleteEventForm">
            <div class="row">
                <div class="col-md-12">
                    <h:outputText value="Delete activity '#{categoriesController.event.title}' starting on "/>
                    <h:outputText value="#{categoriesController.event.startDate}" >
                        <f:convertDateTime pattern="E, dd/MM/yyy" />
                    </h:outputText>?
                </div>
            </div>
            <div class="row" style="float: right">
                <div class="col-md-12">
                    <p:commandButton value="Yes" actionListener="#{categoriesController.deleteEvent()}" onsuccess="PF('deleteDialog').hide();" oncomplete="PF('schedulerDialog').show();" update=":newEventDlg"/>
                    <p:commandButton value="No" onclick="PF('deleteDialog').hide();" />
                </div>
            </div>
        </h:form>
    </p:dialog>
    <script>
        $(document).on("keydown", ".ui-cell-editor-input input", function (event) {
            if (event.keyCode === 13) {
                $(this).closest("tr").find(".ui-row-editor .ui-icon-check").click();
            }
        }
        );
    </script>
</html>

