<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <h:head>
        <title>Gamified Reflection</title>
        <h:outputStylesheet library="webjars" name="bootstrap/4.0.0-alpha.6-1/css/bootstrap.min-jsf.css" />
        <style>
           #{categoriesController.styles}
        </style>
    </h:head>
    <h:body>
        <ui:include src="header.xhtml"/>

        <div class="container jumbotron">
            <h2> Select a skill to manage the corresponding activities </h2>
            <br></br>
            <div class="row">
                <div class="col-md-6">
                    <h:form id="categoryForm">
                        <p:dataTable id="categoriesList"
                                     value="#{categoriesController.categories}"
                                     var="category"
                                     editable="true">

                            <p:ajax event="rowEdit" listener="#{categoriesController.onRowEditCategory}" update="@form:categoriesList" />

                            <p:column headerText="Skills">
                                <p:cellEditor>
                                    <f:facet name="output"><p:commandLink actionListener="#{categoriesController.setSelectedCategory(category)}" value="#{category.title}" ajax="true" process="@this" update=":activitiesForm:activities, :activitiesForm:newActivityButton" /></f:facet>
                                    <f:facet name="input"><p:inputText id="titleInput" value="#{category.title}" style="width:100%"/></f:facet>
                                </p:cellEditor>
                            </p:column>
                            <p:column headerText="Edit" style="width:10%">
                                <p:rowEditor />
                            </p:column>
                            <p:column headerText="Delete" style="width:15%" class="text-center">
                                <p:commandLink value="X" style="color: red" actionListener="#{categoriesController.deleteCategory(category)}" ajax="true" update="@form:categoriesList"/>
                            </p:column>
                        </p:dataTable>
                        <p:commandButton value="Add New Skill" type="button" onclick="PF('newCategoryDialog').show();" />
                    </h:form>
                </div>

                <div class="col-md-6">
                    <h:form id="activitiesForm">
                        <p:dataTable
                            id="activities"
                            value="#{categoriesController.categoryActivities}"
                            var="activity"
                            styleClass="#{categoriesController.selectedCategory eq null ? 'empty' : ''}"
                            emptyMessage="#{categoriesController.selectedCategory eq null ? 'Please select a skill' : 'No activities added'}"
                            editable="true">

                            <p:ajax event="rowEdit" listener="#{categoriesController.onRowEditActivity}" update="@this" />

                            <p:column headerText="#{categoriesController.selectedCategory.title} Activities">
                                <p:cellEditor>
                                    <f:facet name="output"><h:outputText value="#{activity.title}" /></f:facet>
                                    <f:facet name="input"><p:inputText id="titleInput" value="#{activity.title}" style="width:100%"/></f:facet>
                                </p:cellEditor>
                            </p:column>
                            <p:column headerText="Edit" style="width: 10%">
                                <p:rowEditor />
                            </p:column>
                            <p:column headerText="Schedule" style="width: 30%" class="text-center">
                                <p:commandButton value="Schedule" oncomplete="PF('schedulerDialog').show();" actionListener="#{categoriesController.setSelectedActivity(activity)}" update=":newEventDlg"/>
                                <!--                        <p:commandLink value="#//{activity.enabled ? 'Disable' : 'Enable'}" styleClass="#//{!activity.enabled ? 'enabled' : 'disabled'}" actionListener="#//{activitiesController.toggleEnabled(activity)}" ajax="true" update=":activitiesForm"/>-->
                            </p:column>
                            <p:column headerText="Delete" style="width: 15%" class="text-center">
                                <p:commandLink value="X" style="color: red" actionListener="#{categoriesController.deleteActivity(activity)}" ajax="true" update="@form:activities"/>
                            </p:column>
                        </p:dataTable>
                        <p:commandButton id="newActivityButton" disabled="#{categoriesController.selectedCategory eq null}" value="Add New Activity" type="button" onclick="PF('newActivityDialog').show();" style="float: right"/>
                    </h:form>
                </div>
            </div>

        </div>

    </h:body>

    <p:dialog widgetVar="newCategoryDialog" modal="true" dynamic="true" height="100px" showHeader="true" header="Add new skill">
        <p:panel>
            <h:form>
                <p:inputText value="#{categoriesController.newCategoryTitle}"/>
                <p:commandButton actionListener="#{categoriesController.addCategory(categoriesController.newCategoryTitle)}" value="OK" oncomplete="PF('newCategoryDialog').hide();" update="@(:categoriesList)"/>
            </h:form>
        </p:panel>
    </p:dialog>
    <p:dialog widgetVar="newActivityDialog" modal="true" dynamic="true" height="100px" showHeader="true" header="Add new activity">
        <p:panel>
            <h:form>
                <p:inputText value="#{categoriesController.newActivityTitle}"/>
                <p:commandButton actionListener="#{categoriesController.addActivity(categoriesController.newActivityTitle, categoriesController.selectedCategory)}" value="OK" oncomplete="PF('newActivityDialog').hide();}" ajax="true" update="@(:activitiesForm)" resetValues="true"/>
            </h:form>
        </p:panel>
    </p:dialog>
    <p:dialog id="newEventDlg" widgetVar="schedulerDialog" modal="true" header="Select date on which '#{categoriesController.selectedActivity.title}' will be enabled. Click on existing activity to delete." dynamic="true">
        <h:form id="scheduleForm">
            <p:schedule id="schedule" value="#{categoriesController.scheduleModel}" widgetVar="schedule" style="height: 700px" timeZone="GMT+2">
                <p:ajax event="dateSelect" listener="#{categoriesController.onDateSelect}" update="@this"/>
                <p:ajax event="eventSelect" listener="#{categoriesController.onEventSelect}"  oncomplete="PF('deleteDialog').show();" update=":deleteEventDlg"/>
            </p:schedule>
        </h:form>
    </p:dialog>
    <p:dialog id="deleteEventDlg" widgetVar="deleteDialog" modal="true" header="Delete scheduled activity?" dynamic="true">
        <h:form id="deleteEventForm">
            <h:outputText value="Delete activity '#{categoriesController.selectedActivity.title}' starting on #{categoriesController.event.startDate}?" />
            <p:commandButton value="Yes" actionListener="#{categoriesController.deleteEvent()}" onsuccess="PF('deleteDialog').hide();" oncomplete="PF('schedulerDialog').show();" update=":newEventDlg"/>
            <p:commandButton value="No" onclick="PF('deleteDialog').hide();" />
        </h:form>
    </p:dialog>
    <script>
        $(document).on("keydown", ".ui-cell-editor-input input", function (event) {
            if (event.keyCode === 13) {
                $(this).closest("tr").find(".ui-row-editor .ui-icon-check").click();
            }
        }
        );
    </script>
</html>

